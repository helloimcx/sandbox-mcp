# Session管理生命周期流程图

## 会话池和会话管理的完整生命周期

```mermaid
flowchart TD
    A[系统启动] --> B[初始化会话池]
    B --> C[创建预热会话]
    C --> D[会话池填充完成]
    
    D --> E[等待用户请求]
    E --> F{用户请求创建会话}
    
    F --> G{指定session_id?}
    G -->|是| H{会话已存在?}
    G -->|否| I[生成新session_id]
    
    H -->|是| J[复用现有会话]
    H -->|否| K{会话池有可用会话?}
    I --> K
    
    K -->|是| L[从池中获取会话]
    K -->|否| M[创建全新会话]
    
    L --> N[更新会话ID和目录]
    N --> O[处理文件下载]
    M --> P[启动新内核]
    P --> O
    
    J --> Q[检查新文件]
    Q --> R[下载新文件]
    R --> S[返回现有会话]
    
    O --> T[注册到活跃会话]
    T --> U[返回会话给用户]
    
    U --> V[用户执行代码]
    V --> W{用户继续使用?}
    W -->|是| V
    W -->|否| X{用户主动终止?}
    
    X -->|是| Y[调用terminate_session]
    X -->|否| Z[会话变为空闲]
    
    Y --> AA{池未满?}
    Z --> BB[清理检查循环]
    BB --> CC{会话空闲超时?}
    CC -->|是| AA
    CC -->|否| DD[继续监控]
    DD --> BB
    
    AA -->|是| EE[清理会话状态]
    AA -->|否| FF[直接停止会话]
    
    EE --> GG[重启内核]
    GG --> HH[清理工作目录]
    HH --> II[清理文件配置]
    II --> JJ[重置会话元数据]
    JJ --> KK[返回到会话池]
    
    FF --> LL[停止内核]
    LL --> MM[清理资源]
    MM --> NN[从活跃会话移除]
    
    KK --> OO[池维护循环]
    NN --> OO
    OO --> PP{池需要填充?}
    PP -->|是| QQ[创建新的池会话]
    PP -->|否| E
    QQ --> C
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style L fill:#e8f5e8
    style M fill:#fff3e0
    style EE fill:#e8f5e8
    style FF fill:#ffebee
```

## 关键组件说明

### 1. 会话池管理
- **初始化**: 系统启动时创建配置数量的预热会话
- **维护**: 后台循环检查池状态，自动填充到目标大小
- **复用**: 优先从池中获取已初始化的会话，提升创建速度

### 2. 会话生命周期状态
```mermaid
stateDiagram-v2
    [*] --> 池中待用
    池中待用 --> 活跃使用 : 分配给用户
    活跃使用 --> 执行中 : 用户执行代码
    执行中 --> 活跃使用 : 执行完成
    活跃使用 --> 空闲 : 用户停止使用
    空闲 --> 清理中 : 超时或主动终止
    清理中 --> 池中待用 : 清理完成，池未满
    清理中 --> [*] : 池已满，销毁会话
    活跃使用 --> [*] : 直接终止
```

### 3. 文件管理流程
```mermaid
flowchart LR
    A[会话创建请求] --> B{包含文件?}
    B -->|否| C[直接返回会话]
    B -->|是| D[检查现有文件]
    D --> E[下载新文件]
    E --> F[更新文件配置]
    F --> G[返回会话]
    
    H[会话清理] --> I[删除所有文件]
    I --> J[清空文件配置]
    J --> K[会话返回池中]
```

### 4. 性能优化点

1. **预热机制**: 池中会话已完成内核启动，避免用户等待
2. **智能复用**: 优先使用池中会话，显著减少创建时间
3. **延迟清理**: 会话终止时先尝试回收到池中，而非直接销毁
4. **自动维护**: 后台自动维护池大小，确保始终有可用会话

### 5. 配置参数

- `session_pool_size`: 池大小（默认3）
- `session_pool_max_idle_time`: 池中会话最大空闲时间（默认600秒）
- `session_pool_refill_interval`: 池填充检查间隔（默认30秒）
- `max_kernels`: 最大并发会话数
- `kernel_cleanup_interval`: 会话清理检查间隔

这个设计确保了高效的会话管理，通过会话池机制显著提升了用户体验，同时保持了系统资源的合理利用。